{%- set isIndex = 'index' == tmpl -%}
{%- set tmpl = 'list' -%}
{% extends isIndex ? 'MauticCoreBundle:Default:content.html.twig' : 'MauticCoreBundle:Default:raw_output.html.twig' %}

{% block mauticContent 'report' %}

{% block headerTitle 'mautic.report.report.header.view'|trans({'%name%': report.name|trans}) %}

{% block publishStatus include('MauticCoreBundle:Helper:publishstatus_badge.html.twig', {'entity': report}) %}

{% block actions %}
  {%- set buttons = [] -%}
  {% if data is not empty or graphs is not empty %}
      {%- set buttons = buttons|merge([{
          'attr': {
              'target': '_new',
              'data-toggle': '',
              'class': 'btn btn-default btn-nospin',
              'href': path('mautic_report_export', {'objectId': report.id, 'format': 'html'}),
          },
          'btnText': 'mautic.form.result.export.html'|trans,
          'iconClass': 'fa fa-file-code-o',
      }]) -%}

      {% if data is not empty %}
          {%- set buttons = buttons|merge([{
              'attr': {
                  'data-toggle': 'download',
                  'class': 'btn btn-default btn-nospin',
                  'href': path('mautic_report_export', {'objectId': report.id, 'format': 'csv'}),
              },
              'btnText': 'mautic.form.result.export.csv'|trans,
              'iconClass': 'fa fa-file-text-o',
          }]) -%}

          {% if '\\PhpOffice\\PhpSpreadsheet\\Spreadsheet' is class %}
              {%- set buttons = buttons|merge([{
                  'attr': {
                      'data-toggle': 'download',
                      'class': 'btn btn-default btn-nospin',
                      'href': path('mautic_report_export', {'objectId': report.id, 'format': 'xlsx'}),
                  },
                  'btnText': 'mautic.form.result.export.xlsx'|trans,
                  'iconClass': 'fa fa-file-excel-o',
              }]) -%}
          {% endif %}
      {% endif %}
  {% endif %}
  {{ include('MauticCoreBundle:Helper:page_actions.html.twig', {
          'item': report,
          'templateButtons': {
              'edit': securityHasEntityAccess(permissions['report:reports:editown'], permissions['report:reports:editother'], report.createdBy),
              'delete': securityHasEntityAccess(permissions['report:reports:deleteown'], permissions['report:reports:deleteother'], report.createdBy),
              'close': securityHasEntityAccess(permissions['report:reports:viewown'], permissions['report:reports:viewother'], report.createdBy),
          },
          'routeBase': 'report',
          'langVar': 'report.report',
          'customButtons': buttons,
  }) }}
{% endblock %}

{% block content %}
  {#$showDynamicFilters  = (true === !empty($report->getSettings()['showDynamicFilters']));
  $hideDateRangeFilter = (true === !empty($report->getSettings()['hideDateRangeFilter']));#}
  {%- set showDynamicFilters = (report.settings.showDynamicFilters is defined) -%}
  {%- set hideDateRangeFilter = (report.settings.hideDateRangeFilter is defined) -%}

  <!-- report detail header -->
  {% if report.description %}
    <div class="pr-md pl-md pt-lg pb-lg">
        <div class="text-white dark-sm mb-0">{{ report.description|purify }}</div>
    </div>
  {% endif %}
  <!--/ report detail header -->
  <!-- report detail collapseable -->
  <div id="report-shelves" class="mb-5" aria-multiselectable="true">
      <div class="collapse" id="report-details">
          <div class="pr-md pl-md pb-md">
              <div class="panel shd-none mb-0">
                  <table class="table table-bordered table-striped mb-0">
                      <tbody>
                        {{ include('MauticCoreBundle:Helper:details.html.twig', {'entity': report}) }}
                      </tbody>
                  </table>
              </div>
          </div>
      </div>
      <div class="collapse {% if showDynamicFilters %}in{% endif %}" id="report-filters">
          <div class="pr-md pl-md pb-md">
              <div class="panel shd-none mb-0 pa-lg">
                  <div class="row">
                      <div class="col-sm-12 mb-10 {% if hideDateRangeFilter %}hide{% endif %}">
                          {{ include('MauticCoreBundle:Helper:graph_dateselect.html.twig', {'dateRangeForm': dateRangeForm}) }}
                      </div>
                      {{ form_start(dynamicFilterForm) }}
                      {% for child in dynamicFilterForm.children|filter(v => 'hidden' != v.vars.block_prefixes[1]) %}
                        <div class="col-sm-4">
                            {{ form_row(child) }}
                        </div>
                      {% endfor %}
                      {{ form_end(dynamicFilterForm) }}
                  </div>
              </div>
          </div>
      </div>
      <!--/ report detail collapseable -->

      <div class="bg-auto bg-dark-xs">
          <!-- report detail collapseable toggler -->
          <div class="hr-expand nm">
              <a href="#report-details" class="arrow text-muted collapsed" data-toggle="collapse" aria-expanded="false" aria-controls="report-details">
                  <span class="caret"></span> {{ 'mautic.core.details'|trans }}
              </a>
              <a href="#report-filters" class="arrow text-muted {% if not showDynamicFilters %}collapsed{% endif %}" data-toggle="collapse" aria-expanded="false" aria-controls="report-filters">
                  <span class="caret"></span> {{ 'mautic.core.filters'|trans }}
              </a>
          </div>
          <!--/ report detail collapseable toggler -->
      </div>
  </div>

  <div class="report-content">
      {% block _content %}{% endblock %}
  </div>
  {% if debug is defined and debug.count_query is defined %}
    <div class="well">
        <h4>Debug: {{ debug.query_time }}</h4>
        <div>{{ debug.count_query }}</div>
        <br />
        <div>{{ debug.query }}</div>
    </div>
  {% endif %}
  <!--/ end: box layout -->
  <input type="hidden" name="entityId" id="entityId" value="{{ report.id|e }}"/>
{% endblock %}
