dist: trusty
language: php

services:
  - mysql

php:
  - 7.2
  - 7.3

cache:
  directories:
    - $HOME/.composer/cache

before_install:
  # Create mautictest database
  - mysql -e 'CREATE DATABASE mautictest;'

  # increase memory limit for all PHP processes
  - echo "memory_limit=4G" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini

  # turn off XDebug
  - phpenv config-rm xdebug.ini || return

  # install dependencies in parallel
  - travis_retry composer global require hirak/prestissimo

  # set to test environment for Symfony's commands in post install commands
  - export SYMFONY_ENV="test"

  # install PHPSTAN for PHP 7+
  - composer global require phpstan/phpstan-shim:0.8.5

install:
  - composer install

script:

  # Run PHPUnit
  - bin/phpunit --bootstrap vendor/autoload.php --configuration app/phpunit.xml.dist --fail-on-warning

  # Run PHPSTAN analysis for PHP 7+
  - ~/.composer/vendor/phpstan/phpstan-shim/phpstan.phar analyse app/bundles/DashboardBundle app/bundles/ConfigBundle app/bundles/CampaignBundle app/bundles/PointBundle app/bundles/WebhookBundle app/bundles/LeadBundle app/bundles/FormBundle

  # Check if the code standards weren't broken.
  - bin/php-cs-fixer fix -v --dry-run --diff
